<?php
$con = mysqli_connect('DB_HOST', 'DB_USERNAME', 'DB_PASSWORD');
if (!$con) {
  exit('データベースに接続できませんでした。');
}

$result = mysqli_select_db($con, 'DB_DATABASE');
if (!$result) {
  exit('データベースを選択できませんでした。');
}

$result = mysqli_query($con, 'SET NAMES utf8');
if (!$result) {
  exit('文字コードを指定できませんでした。');
}

$Root = [[],[40.59906,140.481401],[40.599351,140.481927],[40.599642,140.482453],[40.599934,140.482978],[40.599686,140.483443],[40.599438,140.483908],[40.599151,140.484028],[40.598863,140.484149],[40.598924,140.484471],[40.598527,140.484642],[40.59842,140.484237],[40.598201,140.483938],[40.597982,140.483639],[40.597763,140.48334],[40.597543,140.483042],[40.597295,140.482738],[40.5970725,140.4823995],[40.596794,140.482069],[40.59654,140.481704],[40.596328,140.481414],[40.596116,140.481124],[40.595905,140.480834],[40.595745,140.480564],[40.595608,140.480244],[40.595527,140.479883],[40.595446,140.479522],[40.595365,140.479161],[40.595284,140.4788],[40.595204,140.47844],[40.595461,140.478172],[40.595747,140.477962],[40.596028,140.477644],[40.596346,140.477398],[40.596692,140.47708],[40.597046,140.476776],[40.597333,140.476543],[40.597632,140.476275],[40.597931,140.476007],[40.59823,140.47574],[40.5986055,140.475422],[40.598923,140.47514],[40.59924,140.474858],[40.599557,140.474576],[40.599873,140.474295],[40.600257,140.473961],[40.60055,140.4737],[40.600843,140.473439],[40.601136,140.473178],[40.601401,140.472923],[40.601666,140.472668],[40.601931,140.472413],[40.602195,140.472157],[40.602623,140.471741],[40.602841,140.471452],[40.603017,140.471039],[40.603114,140.47065],[40.603218,140.4701],[40.603321,140.469551],[40.602956,140.469462],[40.602591,140.469372],[40.602226,140.469283],[40.60186,140.469193],[40.601442,140.469097],[40.601024,140.469001],[40.600712,140.468919],[40.600399,140.468836],[40.600482,140.468362],[40.600565,140.467888],[40.600649,140.467414],[40.600732,140.46694],[40.600815,140.466465],[40.600489,140.466356],[40.600163,140.466247],[40.599838,140.466137],[40.599915,140.465696],[40.600258,140.46564],[40.600589,140.465734],[40.600919,140.465827],[40.600992,140.465405],[40.601065,140.464983],[40.601137,140.464561],[40.60121,140.46414],[40.601516,140.464223],[40.601822,140.464306],[40.602128,140.464389],[40.602434,140.464472],[40.602739,140.464553],[40.603029,140.464646],[40.603319,140.464739],[40.60361,140.464832],[40.603552,140.465215],[40.603494,140.465598],[40.603436,140.465981],[40.603364,140.466456],[40.603292,140.466931],[40.60322,140.467407],[40.603579,140.467497],[40.603938,140.467587],[40.604296,140.467677],[40.604656,140.46776],[40.605016,140.467843],[40.605376,140.467927],[40.605735,140.468014],[40.606094,140.468101],[40.606454,140.468187],[40.606813,140.468274],[40.607172,140.468361],[40.607532,140.468447],[40.60749,140.468907],[40.607447,140.469367],[40.60738,140.469862],[40.607189,140.470143],[40.606997,140.470423],[40.606645,140.470342],[40.606293,140.470261],[40.605942,140.470181],[40.60559,140.470101],[40.605238,140.470021],[40.604887,140.46994],[40.604823,140.470346],[40.604759,140.470752],[40.604695,140.471158],[40.604630,140.471565],[40.604525,140.472053],[40.604403,140.472405],[40.604204,140.472791],[40.604031,140.473073],[40.603756,140.473423],[40.603436,140.473743],[40.603115,140.474063],[40.602899,140.474408],[40.602727,140.474737],[40.602555,140.475065],[40.602398,140.475365],[40.602241,140.475665],[40.602068,140.475968],[40.601895,140.476271],[40.601722,140.476574],[40.601548,140.476875],[40.601364,140.477166],[40.601139,140.477472],[40.600972,140.477747],[40.600805,140.478022],[40.600637,140.478296],[40.600546,140.478642],[40.600454,140.478989],[40.600387,140.479365],[40.600309,140.479758],[40.600264,140.480101],[40.600219,140.480444],[40.599842,140.480352],[40.599465,140.480261],[40.59913,140.480188],[40.598707,140.480185],[40.598312,140.480305],[40.598023,140.480492],[40.597811,140.480665],[40.597599,140.480838],[40.597387,140.481011],[40.597175,140.481184],[40.596963,140.481357],[40.596751,140.48153]];
$bus_stop = [0,2,10,17,23,31,33,36,40,45,48,52,64,75,87,93,110,123,127,133,152,163,1000];
$between_time = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];

$current_time = $_GET["start_time"];
$before_time = $_GET["start_time"];
$current_num = $_GET["start_num"];
$phone_num = $_GET["phone"];
$flag = false;

for ($i=1; $i<count($bus_stop); $i++) {
    if ($current_num < $bus_stop[$i]) {
        $current_index = $i-1;
        break;
    }
}

$count = floor((strtotime(preg_split('/ /', $current_time)[0]." 17:00:00") - strtotime($current_time))/5);
for ($i=1; $i<=$count; $i++) {
    $current_time = date("Y-m-d H:i:s", strtotime($current_time." 5 second"));
    $row = mysqli_fetch_array(mysqli_query($con, "SELECT * FROM bus WHERE bus_id = 'phone".$phone_num."' AND sdate < '".$current_time."' ORDER BY sdate DESC LIMIT 0,1"));
    $Num = compare([(float)$row["lat"],(float)$row["lng"]]);
    if ($current_num == 1) {
        $current_num = 1000;
        $current_index = 0;
        $before_time = $current_time;
    }
    elseif ($current_num == 1000) {
        if ($Num > 2 && $Num < 6) {
            $current_num = 2;
            pass(0);
        }
    }
    elseif ($current_num > count($Root)-10 && $Num < 20 && $Num > 2) {
        $current_num = $Num;
        pass(20);
    }
    elseif ($current_num > count($Root)-20 && $Num <= 2) {}
    elseif (abs($Num-$current_num) > 20) {}
    elseif ($Num-$current_num > 3) {
        $current_num += 3;
        if ($current_num >= $bus_stop[$current_index+1]) {pass($current_index);}
    }
    elseif ($Num-$current_num < -3) {
        $current_num -= 3;
    }
    else {
        $current_num = $Num;
        if ($current_num >= $bus_stop[$current_index+1]) {pass($current_index);}
    }
}

function euclid($begin,$end) {
    return sqrt(($end[1] - $begin[1])**2 + ($end[0] - $begin[0])**2);
}

function compare($point) {
    global $Root;
    $value = INF;
    $num = 0;
    for ($j=1; $j<count($Root); $j++) {
        $d = euclid($point,$Root[$j]);
        if ($d < $value) {
            $value = $d;
            $num = $j;
        }
    }
    return $num;
}

function pass($index) {
    global $flag, $between_time, $current_index, $current_time, $before_time;
    if ($flag) {$between_time[$index][] = strtotime($current_time) - strtotime($before_time);}
    else {$flag = true;}
    $current_index += 1;
    $before_time = $current_time;
}

$con = mysqli_close($con);
if (!$con) {
    exit('データベースとの接続を閉じられませんでした。');
}

echo "各バス停から次のバス停へ到着するのにかかった時間";
foreach ($between_time as $row) {
    echo ",<br>[".implode(",", $row)."]";
}
?>

<!DOCTYPE html>
<html lang="ja">
    <head>
        <title>バス移動時間計算</title>
    </head>
</html>
